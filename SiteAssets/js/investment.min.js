"use strict";function createViz(a,b){function Q(){d3.selectAll("g.row").on("mouseover",function(a){var b=a.key,c=currFormat(a.value.amount),d=a.value.count,e=perFormat(a.value.percent);showDetail(b,c,d,e)}).on("mouseout",hideDetail),d3.selectAll("g.stack rect.bar").on("mouseover",function(a){var b=a.layer,c=currFormat(a.data.value.amount),d=perFormat(a.data.value.percent);showDetail(b,c,null,d)}).on("mouseout",hideDetail)}function R(a){var b=+a.select("svg").attr("width"),c=+a.select("svg").attr("height"),d=+c/b*100+"%",e=a.select("svg"),f=d3.select(a.select("svg").node().parentNode);e.attr({class:"scaling-svg",preserveAspectRatio:"xMinYMin",viewBox:"0 0 "+b+" "+c,width:null,height:null}),f.style("padding-bottom",d)}if(a)throw a;spinner.stop();var c=getSize().height,d=document.querySelector("div.w3-main > header").offsetHeight,e=document.querySelector("div.w3-main > footer").offsetHeight,f=document.querySelector("#barChart header").offsetHeight,g=document.querySelector("#barChart footer").offsetHeight,h=1*(c-d-e-f-g)/4,i=document.querySelector("#rowChart header").offsetHeight,j=document.querySelector("#rowChart footer").offsetHeight,k=1*(c-d-e-i-j)/2,l=document.querySelector("#tableChart header").offsetHeight,m=document.querySelector("#tableChart footer").offsetHeight,n=1*(c-d-e-l-m)/3*.85,o=document.querySelector("#tableChart footer").clientWidth,p=document.querySelector("#barChart footer").clientWidth,q=document.querySelector("#rowChart footer").clientWidth,r={top:25,right:10,bottom:20,left:10},s=[],t=b.value.map(function(a){return a.Total=1e3*+a.Total,a.DME=1e3*+a.DME,a.SS=1e3*+a.SS,a.PercentageChange=+a.PercentageChange||0,a.PercentageDME=+a.PercentageDME||0,a.PercentageSS=+a.PercentageSS||0,a.Year=+a.Year,s.indexOf(a.Year)<0&&s.push(a.Year),a});s.sort();var u=crossfilter(t),v=u.dimension(function(a){return a.Component}),w=u.dimension(function(a){return a.Year}),x=u.dimension(function(a){return a.InvestmentName}),y=u.dimension(function(a){return a.Id}),z=u.groupAll(),A=v.group().reduceSum(function(a){return Math.round(a.Total)}),B=x.group().reduce(function(a,b){return++a.count,a.amount+=Math.round(b.Total),a},function(a,b){return--a.count,a.amount-=Math.round(b.Total),a},function(){return{count:0,amount:0}}).order(function(a){return a.amount}),C=w.group().reduce(function(a,b){return++a.count,a.amount+=Math.round(b.DME),a.total+=Math.round(b.Total),a.percent=+a.amount/a.total,a},function(a,b){return--a.count,a.amount-=Math.round(b.DME),a.total-=Math.round(b.Total),a.percent=+a.amount/a.total,a},function(){return{count:0,amount:0,total:0,percent:0}}),D=w.group().reduce(function(a,b){return++a.count,a.amount+=Math.round(b.SS),a.total+=Math.round(b.Total),a.percent=+a.amount/a.total,a},function(a,b){return--a.count,a.amount-=Math.round(b.SS),a.total-=Math.round(b.Total),a.percent=+a.amount/a.total,a},function(){return{count:0,amount:0,total:0,percent:0}}),E=u.groupAll().reduceSum(function(a){return Math.round(a.Total)});w.filter(2017);var F=dc.selectMenu("#components"),G=dc.rowChart("#top-investments"),H=dc.barChart("#chart-amount"),I=dc.dataTable("#data-table");F.dimension(v).group(A).multiple(!1).numberVisible(null).title(function(a){return a.key}).promptText("All Components").promptValue(null),F.on("pretransition",function(a){d3.select("#components").classed("dc-chart",!1),a.select("select").classed("w3-form",!0)}),dc.numberDisplay("#total-spend").formatNumber(dFormat).valueAccessor(function(a){return a}).group(E).formatNumber(function(a){return formatAbbreviation(Math.abs(a))}),dc.dataCount("#data-count").dimension(u).group(z),H.width(p).height(h).dimension(w).group(C,"DME").valueAccessor(function(a){return a.value.amount}).stack(D,"Steady State",function(a){return a.value.amount}).ordinalColors(colorbrewer.PuOr[6]).x(d3.scale.ordinal().domain(s)).elasticX(!1).xUnits(dc.units.ordinal).barPadding(.15).legend(dc.legend().horizontal(!0).x(p/2)).margins({top:r.top,right:r.right,bottom:r.bottom,left:r.left+50}).renderLabel(!1).renderTitle(!1).renderHorizontalGridLines(!0).elasticY(!0).yAxisLabel("Total IT Spend per Year").yAxis().ticks(Math.max(h/50,2)).tickFormat(function(a){return formatAbbreviation(a)}),H.on("pretransition",function(a){R(a)}),H.addFilterHandler(function(a,b){return a.length=0,a.push(b),a}),H.filter(2017),G.width(q).height(k).dimension(x).group(B).ordinalColors(colorbrewer.PuOr[6]).valueAccessor(function(a){return a.value.amount}).label(function(a){if(G.hasFilter()&&!G.hasFilter(a.key))return a.key+" (0%)";var b=a.key;return z.value()&&(a.value.percent=a.value.amount/E.value(),b+=" ("+perFormat(a.value.percent)+")"),b}).title(function(a){return a.value.amount}).margins({top:r.top,right:r.right,bottom:r.bottom,left:r.left}).rowsCap(10).othersGrouper(!1).ordering(function(a){return-a.value.amount}).on("pretransition",function(a){R(a),a.selectAll("g.row text").style({fill:function(a){return 0!=a.value.amount?"black":"none"}})}).renderTitle(!1).elasticX(!0).xAxis().ticks(Math.max(h/50,2)).tickFormat(function(a){return formatAbbreviation(a)});for(var J=0,K=0,L=0,M="<thead><tr>",N=0;N<columns.length;N++){var O="",P="";"double"==columns[N].type&&!L>0&&(L=N+1),columns[N].display||(K++,O="display:none;"),columns[N].sort?(J=N,P="sorting_asc"):P="sorting",M+="<th class='"+P+"' rowspan='1' colspan='1' style='"+O+"' data-col='"+columns[N].field+"'>"+columns[N].label+"</th>"}M+="</tr></thead>",$(".dc-data-tables_scrollHeadInner > table").append(M),I.width(o).height(n).dimension(y).group(function(a){return a}).showGroups(!1).columns(columns).sortBy(function(a){return a[columns[J].field]}).size(1/0).order(d3.ascending).on("renderlet",function(a){function b(){function e(a,b,c){for(var g,h,d=0,e=0,f=b.length;e<f;){for(g=b[e].firstChild,h=c?c[e].firstChild:null;g;)1===g.nodeType&&(c?a(g,h,d):a(g,d),d++),g=g.nextSibling,h=c?h.nextSibling:null;e++}}function f(a){return null===a?"0px":"number"==typeof a?a<0?"0px":a+"px":a.match(/\d$/)?a+"px":a}var F,G,H,I,J,K,P,Q,R,g={bCollapse:!0,iBarWidth:17,sX:"",sXInner:"",sY:n+"px"},h=g.sX,i=g.sXInner,j=g.sY,k=g.iBarWidth,l=$("div.dc-data-tables_scrollHead"),m=l[0].style,o=l.children("div"),p=o[0].style,q=o.children("table"),r=$("div.dc-data-tables_scrollBody")[0],s=$(r),t=r.style,u=$("div.dc-data-tables_scrollFoot"),v=u.children("div"),x=(v.children("table"),$("div.dc-data-tables_scrollHead thead")),y=$("div.dc-data-tables_scrollBody table"),z=y[0],A=z.style,B=$("div.dc-data-tables_scrollFoot tfoot"),C={bScrollOversize:!1,bScrollbarLeft:!1,bBounding:!0,barWidth:17},D=C.bScrollOversize,E=[],L=[],M=[],N=[],O=[],S=function(a){var b=a.style;b.paddingTop="0",b.paddingBottom="0",b.borderTopWidth="0",b.borderBottomWidth="0",b.height=0};$("div.dc-data-tables_scrollHead table thead th").each(function(){E.push(this)});r.scrollHeight,r.clientHeight;y.children("thead, tfoot").remove(),B&&(K=B.clone().prependTo(y),G=B.find("tr"),I=K.find("tr")),J=x.clone().prependTo(y),F=x.find("tr"),H=J.find("tr"),J.find("th, td").removeAttr("tabindex"),h||(t.width="100%",l[0].style.width="100%"),$.each(J,function(a,b){P=a,b.style.width=b.style.width}),B&&e(function(a){a.style.width=""},I),R=y.outerWidth(),""===h?(A.width="100%",D&&(y.find("tbody").height()>r.offsetHeight||"scroll"==s.css("overflow-y"))&&(A.width=f(y.outerWidth()-k)),R=y.outerWidth()):""!==i&&(A.width=f(i),R=y.outerWidth()),e(S,H),e(function(a){N.push(a.innerHTML),L.push(f($(a).css("width")))},H),e(function(a,b){-1!==$.inArray(a,E)&&(a.style.width=L[b])},F),$(H).height(0),B&&(e(S,I),e(function(a){O.push(a.innerHTML),M.push(f($(a).css("width")))},I),e(function(a,b){a.style.width=M[b]},G),$(I).height(0)),e(function(a,b){a.innerHTML='<div class="dataTables_sizing" style="height:0;overflow:hidden;">'+N[b]+"</div>",a.style.width=L[b]},H),B&&e(function(a,b){a.innerHTML='<div class="dataTables_sizing" style="height:0;overflow:hidden;">'+O[b]+"</div>",a.style.width=M[b]},I),y.outerWidth()<R?(Q=r.scrollHeight>r.offsetHeight||"scroll"==s.css("overflow-y")?R+k:R,D&&(r.scrollHeight>r.offsetHeight||"scroll"==s.css("overflow-y"))&&(A.width=f(Q-k))):Q="100%",t.width=f(Q),m.width=f(Q),j||D&&(t.height=f(z.offsetHeight+k));var U=y.outerWidth();q[0].style.width=f(U),p.width=f(U);var V=y.height()>r.clientHeight||"scroll"==s.css("overflow-y");p["padding"+(C.bScrollbarLeft?"Left":"Right")]=V?k+"px":"0px",y.children("colgroup").insertBefore(y.children("thead")),s.scroll()}$("th:nth-child(-n+"+K+")").not("th:nth-child("+J+")").css("display","none"),$("td:nth-child(-n+"+K+")").not("th:nth-child("+J+")").css("display","none"),$("td:nth-child(n+"+L+")").css("text-align","right"),b()}),dc.renderAll(),Q(),d3.select("#dateHeader").text(moment().format("LLL")),$(".dc-data-tables_scrollHead table > thead > tr").on("click","th",function(){var a=$(this),b=a.attr("data-col");a.is(".sorting_asc")||a.is(".sorting_desc")?a.toggleClass("sorting_asc sorting_desc"):(a.addClass("sorting_asc").removeClass("sorting"),a.siblings().removeClass("sorting_asc sorting_desc"),a.siblings().addClass("sorting"));var c;c=a.hasClass("sorting_asc")?d3.ascending:d3.descending,y.dispose(),y=u.dimension(function(a){return a[b]}),I.dimension(y).sortBy(function(a){return a[b]}).size(1/0).order(c),I.redraw()}),$("#data-table").on("click","tbody tr a",function(a){var b=d3.select($(this).closest("table")[0]),c=d3.select($(this).closest("tr")[0]),d=c.selectAll("td")[0].map(function(a){return void 0!==a.firstChild&&void 0!==a.firstChild.textContent?a.firstChild.textContent:a.textContent}),e=b.selectAll("thead th")[0].map(function(a){return a.textContent}),f=e.map(function(a,b){var c={};return c.key=a,c.value=d[b],c});$("#tableDiv table").remove();var g=d3.select("#tableDiv").append("table").attr({id:"modal-table",class:"table table-bordered"}).style({width:"100%","table-layout":"fixed"}),h=g.append("tbody"),i=h.selectAll("tr").data(f);i.enter().append("tr"),i.exit().remove(),i.append("td").text(function(a){return a.key}),i.append("td").text(function(a){return a.value})})}function getData(){function g(b,c,d,e,f,g,h){var j,i="";return a?(i="../SiteAssets/data/"+d+".json",j=d3.json(i)):(i="web"!==c?b+"/_api/web/lists/GetByTitle('"+d+"')/items?$select="+e+"&$expand="+f+"&$filter="+g+"&$top="+h:b+"/_api/web/"+d,j=d3.json(i).header("accept","application/json;odata=nometadata")),j}var a="",b="",c=[],d="",e="",f="";try{void 0!==typeof _spPageContextInfo&&(b=_spPageContextInfo.webAbsoluteUrl,a=!1)}catch(c){b=void 0,a=!0}for(var h=0;h<columns.length;h++)c.push(columns[h].field);d="",e="(InvestmentName ne null) and (Year gt 2013) and (Total ne 0)",f=3e3,g(b,"list","AnnualBudgetData",c.toString(),d,e,f).get(function(a,b){createViz(a,b)})}var columns=[{label:"Id",field:"Id",format:function(a){return a.Id},type:"string",display:!1,sort:!1},{label:"UII",field:"UII",format:function(a){return a.UII},type:"string",display:!1,sort:!1},{label:"Investment Number",field:"InvestmentNumber",format:function(a){return a.InvestmentNumber},type:"string",display:!1,sort:!1},{label:"Investment Type",field:"InvestmentType",format:function(a){return a.InvestmentType},type:"string",display:!1,sort:!1},{label:"Year",field:"Year",format:function(a){return a.Year},type:"integer",display:!1,sort:!1},{label:"Component",field:"Component",format:function(a){return a.Component},type:"string",display:!0,sort:!1},{label:"Investment Name",field:"InvestmentName",format:function(a){return"<a href=# onclick=document.getElementById(&#39;itemModal&#39;).style.display=&#39;block&#39;>"+a.InvestmentName+"</a>"},type:"string",display:!0,sort:!0},{label:"% DME",field:"PercentageDME",format:function(a){return perFormat(a.PercentageDME)},type:"double",display:!0,sort:!1},{label:"% SS",field:"PercentageSS",format:function(a){return perFormat(a.PercentageSS)},type:"double",display:!0,sort:!1},{label:"DME",field:"DME",format:function(a){return currFormat(a.DME)},type:"double",display:!0,sort:!1},{label:"SS",field:"SS",format:function(a){return currFormat(a.SS)},type:"double",display:!0,sort:!1},{label:"Total",field:"Total",format:function(a){return currFormat(a.Total)},type:"double",display:!0,sort:!1},{label:"% &#9651; PY",field:"PercentageChange",format:function(a){return perFormat(a.PercentageChange)},type:"double",display:!0,sort:!1}],opts={lines:9,length:9,width:5,radius:14,color:"#c10e19",speed:1.9,trail:40,className:"spinner"},target=document.getElementById("dashboard"),spinner=new Spinner(opts).spin(target);getData();